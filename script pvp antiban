-- ANTI-BAN OPTIMIZED: Health Bar cho T·∫§T C·∫¢ ng∆∞·ªùi ch∆°i + Hi·ªán "0.0 / 0.0" khi ch·∫øt + Hi·ªán khi ·ªü g·∫ßn
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Cleanup c≈©
local sgName = "SafeTinyHealthBar"
local old = player:FindFirstChild("PlayerGui"):FindFirstChild(sgName)
if old then old:Destroy() end

-- T·∫°o ScreenGui ch√≠nh
local screenGui = Instance.new("ScreenGui")
screenGui.Name = sgName
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = player:WaitForChild("PlayerGui")

local billboards = {}
local conns = {}
local MAX_DISTANCE = 60
local VISIBLE_DISTANCE = 65

-- H√†m ki·ªÉm tra v√† t·∫°o l·∫°i cho t·∫•t c·∫£ ng∆∞·ªùi ch∆°i (quan tr·ªçng)
local function refreshAllPlayers()
    -- Duy·ªát qua t·∫•t c·∫£ ng∆∞·ªùi ch∆°i trong server
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player then
            -- X√≥a billboard c≈© n·∫øu c√≥
            if billboards[p] then
                pcall(function() billboards[p]:Destroy() end)
                billboards[p] = nil
            end
            
            -- X√≥a connections c≈©
            if conns[p] then
                for _, conn in ipairs(conns[p]) do
                    pcall(function() conn:Disconnect() end)
                end
                conns[p] = nil
            end
            
            -- T·∫°o m·ªõi n·∫øu c√≥ character
            if p.Character then
                task.spawn(function() createHealthBar(p) end)
            end
        end
    end
end

-- H√†m t·∫°o health bar cho 1 player
local function createHealthBar(targetPlayer)
    if targetPlayer == player then return end
    
    -- X√≥a billboard c≈© n·∫øu c√≥ (double check)
    if billboards[targetPlayer] then
        pcall(function() 
            billboards[targetPlayer]:Destroy() 
            billboards[targetPlayer] = nil
        end)
    end
    
    -- X√≥a connections c≈©
    if conns[targetPlayer] then
        for _, conn in ipairs(conns[targetPlayer]) do
            pcall(function() conn:Disconnect() end)
        end
        conns[targetPlayer] = nil
    end
    
    local function setup(char)
        if not char then return end
        
        -- ƒê·ª£i ƒë·∫ßy ƒë·ªß components
        local hrp = char:WaitForChild("HumanoidRootPart", 10)
        local head = char:WaitForChild("Head", 10)
        local humanoid = char:WaitForChild("Humanoid", 10)
        
        if not hrp or not head or not humanoid then 
            print("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y components cho", targetPlayer.Name)
            return 
        end
        
        -- X√≥a billboard c≈© n·∫øu c√≥
        if billboards[targetPlayer] then
            pcall(function() billboards[targetPlayer]:Destroy() end)
        end
        
        -- T·∫°o BillboardGui M·ªöI
        local bb = Instance.new("BillboardGui")
        bb.Name = "SafeHealth_" .. targetPlayer.Name
        bb.Adornee = head
        bb.AlwaysOnTop = true
        bb.LightInfluence = 0
        bb.Size = UDim2.new(0, 180, 0, 40)
        bb.StudsOffset = Vector3.new(0, 3.2, 0)
        bb.Enabled = false
        bb.ResetOnSpawn = false
        bb.Parent = screenGui
        
        -- Background ch√≠nh
        local bg = Instance.new("Frame", bb)
        bg.Size = UDim2.new(1, 0, 1, 0)
        bg.BackgroundColor3 = Color3.fromRGB(22, 22, 32)
        bg.BackgroundTransparency = 0.3
        bg.BorderSizePixel = 0
        
        local corner = Instance.new("UICorner", bg)
        corner.CornerRadius = UDim.new(0, 10)
        
        local stroke = Instance.new("UIStroke", bg)
        stroke.Color = Color3.fromRGB(100, 200, 255)
        stroke.Thickness = 2
        stroke.Transparency = 0.3
        
        -- Thanh m√°u n·ªÅn
        local barBg = Instance.new("Frame", bg)
        barBg.Size = UDim2.new(0.94, 0, 0.4, 0)
        barBg.Position = UDim2.new(0.03, 0, 0.35, 0)
        barBg.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        barBg.BorderSizePixel = 0
        
        local barCorner = Instance.new("UICorner", barBg)
        barCorner.CornerRadius = UDim.new(0, 6)
        
        -- Thanh m√°u ƒë·ªông
        local healthBar = Instance.new("Frame", barBg)
        healthBar.Size = UDim2.new(1, 0, 1, 0)
        healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
        healthBar.BorderSizePixel = 0
        
        local hCorner = Instance.new("UICorner", healthBar)
        hCorner.CornerRadius = UDim.new(0, 6)
        
        -- Text hi·ªÉn th·ªã m√°u
        local txt = Instance.new("TextLabel", bg)
        txt.Size = UDim2.new(0.94, 0, 0.5, 0)
        txt.Position = UDim2.new(0.03, 0, 0.02, 0)
        txt.BackgroundTransparency = 1
        txt.TextColor3 = Color3.new(1, 1, 1)
        txt.TextScaled = true
        txt.Font = Enum.Font.GothamBlack
        txt.TextStrokeTransparency = 0.2
        txt.TextStrokeColor3 = Color3.new(0, 0, 0)
        txt.Text = "100.0 / 100.0"
        
        -- T√™n ng∆∞·ªùi ch∆°i
        local nameLabel = Instance.new("TextLabel", bg)
        nameLabel.Size = UDim2.new(0.5, 0, 0.2, 0)
        nameLabel.Position = UDim2.new(0.03, 0, 0.85, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.TextColor3 = Color3.fromRGB(200, 200, 255)
        nameLabel.TextScaled = true
        nameLabel.Font = Enum.Font.Gotham
        nameLabel.TextStrokeTransparency = 0.5
        nameLabel.Text = targetPlayer.Name
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        
        billboards[targetPlayer] = bb
        
        -- H√†m c·∫≠p nh·∫≠t m√°u
        local function updateHealth()
            if not humanoid or not humanoid.Parent then return end
            
            local health = humanoid.Health
            local maxHealth = humanoid.MaxHealth
            
            if health <= 0 then
                txt.Text = "0.0 / 0.0"
                healthBar.Size = UDim2.new(0, 0, 1, 0)
                healthBar.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
                healthBar.BackgroundTransparency = 0
            else
                txt.Text = string.format("%.1f / %.1f", health, maxHealth)
                local perc = math.clamp(health / maxHealth, 0, 1)
                healthBar.Size = UDim2.new(perc, 0, 1, 0)
                
                if perc > 0.6 then
                    healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
                elseif perc > 0.3 then
                    healthBar.BackgroundColor3 = Color3.fromRGB(255, 200, 0)
                else
                    healthBar.BackgroundColor3 = Color3.fromRGB(255, 100, 0)
                    healthBar.BackgroundTransparency = 0.2 + 0.2 * math.sin(tick() * 10)
                end
            end
        end
        
        -- T·∫°o connections M·ªöI
        local healthConns = {
            humanoid:GetPropertyChangedSignal("Health"):Connect(updateHealth),
            humanoid:GetPropertyChangedSignal("MaxHealth"):Connect(updateHealth),
            humanoid.Died:Connect(function()
                txt.Text = "0.0 / 0.0"
                healthBar.Size = UDim2.new(0, 0, 1, 0)
                healthBar.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
            end)
        }
        
        conns[targetPlayer] = healthConns
        
        -- C·∫≠p nh·∫≠t ngay
        updateHealth()
        print("‚úÖ ƒê√£ t·∫°o health bar cho", targetPlayer.Name)
    end
    
    -- N·∫øu ƒë√£ c√≥ character, setup NGAY
    if targetPlayer.Character then
        task.spawn(setup, targetPlayer.Character)
    else
        -- N·∫øu ch∆∞a c√≥ character, ch·ªù v√† th·ª≠ l·∫°i
        task.spawn(function()
            local timeout = 0
            while not targetPlayer.Character and timeout < 50 do
                task.wait(0.1)
                timeout = timeout + 1
            end
            if targetPlayer.Character then
                setup(targetPlayer.Character)
            end
        end)
    end
    
    -- K·∫øt n·ªëi CharacterAdded
    local charConn
    charConn = targetPlayer.CharacterAdded:Connect(function(char)
        -- X√≥a billboard c≈©
        if billboards[targetPlayer] then
            pcall(function() billboards[targetPlayer]:Destroy() end)
            billboards[targetPlayer] = nil
        end
        
        -- X√≥a connections c≈©
        if conns[targetPlayer] then
            for _, conn in ipairs(conns[targetPlayer]) do
                pcall(function() conn:Disconnect() end)
            end
            conns[targetPlayer] = nil
        end
        
        -- ƒê·ª£i character load
        task.wait(0.3)
        setup(char)
    end)
    
    -- L∆∞u connection
    if not conns.char then conns.char = {} end
    conns.char[targetPlayer] = charConn
end

-- QUAN TR·ªåNG: Kh·ªüi t·∫°o cho T·∫§T C·∫¢ ng∆∞·ªùi ch∆°i hi·ªán t·∫°i (ƒë·∫£m b·∫£o kh√¥ng ai b·ªã s√≥t)
for _, p in ipairs(Players:GetPlayers()) do
    if p ~= player then
        task.spawn(createHealthBar, p)
    end
end

-- X·ª≠ l√Ω ng∆∞·ªùi ch∆°i m·ªõi join
Players.PlayerAdded:Connect(function(p)
    if p ~= player then
        -- Delay nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o
        task.wait(0.2)
        task.spawn(createHealthBar, p)
    end
end)

-- D·ªçn d·∫πp khi r·ªùi
Players.PlayerRemoving:Connect(function(p)
    if billboards[p] then
        pcall(function() billboards[p]:Destroy() end)
        billboards[p] = nil
    end
    
    if conns[p] then
        for _, conn in ipairs(conns[p]) do
            pcall(function() conn:Disconnect() end)
        end
        conns[p] = nil
    end
    
    if conns.char and conns.char[p] then
        pcall(function() conns.char[p]:Disconnect() end)
        conns.char[p] = nil
    end
end)

-- X·ª≠ l√Ω khi local player teleport/respawn
local function onLocalCharacterAdded()
    -- ƒê·∫£m b·∫£o screenGui trong PlayerGui m·ªõi
    local newGui = player:FindFirstChild("PlayerGui")
    if newGui and screenGui.Parent ~= newGui then
        screenGui.Parent = newGui
    end
    
    -- Refresh t·∫•t c·∫£ players sau teleport
    task.wait(0.5)
    refreshAllPlayers()
end

-- Theo d√µi local player respawn/teleport
player.CharacterAdded:Connect(onLocalCharacterAdded)

-- CHECK KHO·∫¢NG C√ÅCH M·ªñI FRAME
local frameCount = 0
RunService.RenderStepped:Connect(function()
    frameCount = frameCount + 1
    if frameCount % 2 ~= 0 then return end
    
    -- ƒê·∫øm s·ªë l∆∞·ª£ng billboard ƒëang ho·∫°t ƒë·ªông
    local activeCount = 0
    local totalCount = 0
    
    for plr, bb in pairs(billboards) do
        totalCount = totalCount + 1
        if bb and bb.Parent and plr then
            -- Ki·ªÉm tra character
            if plr.Character then
                local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
                local head = plr.Character:FindFirstChild("Head")
                
                if hrp and head then
                    -- C·∫≠p nh·∫≠t Adornee
                    if bb.Adornee ~= head then
                        bb.Adornee = head
                    end
                    
                    -- T√≠nh kho·∫£ng c√°ch
                    local dist = (camera.CFrame.Position - hrp.Position).Magnitude
                    
                    -- B·∫≠t/t·∫Øt
                    if dist <= MAX_DISTANCE then
                        if not bb.Enabled then
                            bb.Enabled = true
                            activeCount = activeCount + 1
                        else
                            activeCount = activeCount + 1
                        end
                    elseif dist > VISIBLE_DISTANCE then
                        if bb.Enabled then
                            bb.Enabled = false
                        end
                    end
                else
                    if bb.Enabled then
                        bb.Enabled = false
                    end
                end
            else
                if bb.Enabled then
                    bb.Enabled = false
                end
            end
        else
            -- X√≥a billboard kh√¥ng h·ª£p l·ªá
            billboards[plr] = nil
        end
    end
    
    -- Debug nh·∫π (c√≥ th·ªÉ x√≥a d√≤ng n√†y n·∫øu kh√¥ng c·∫ßn)
    if frameCount % 300 == 0 then
        print(string.format("üìä Health bars: %d/%d active", activeCount, totalCount))
    end
end)

-- T·∫Øt health bar m·∫∑c ƒë·ªãnh
task.wait(0.5)
pcall(function()
    game:GetService("StarterGui"):SetCoreGuiEnabled(Enum.CoreGuiType.Health, false)
end)

-- Refresh ƒë·ªãnh k·ª≥ ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng ai b·ªã m·∫•t (m·ªói 30 gi√¢y)
task.spawn(function()
    while true do
        task.wait(30)
        -- Ki·ªÉm tra v√† t·∫°o l·∫°i cho nh·ªØng player ch∆∞a c√≥ billboard
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= player and p.Character and not billboards[p] then
                print("üîÑ T·∫°o l·∫°i health bar cho", p.Name)
                task.spawn(createHealthBar, p)
            end
        end
    end
end)

print("‚úÖ HEALTH BAR FIXED: HI·ªÜN CHO T·∫§T C·∫¢ NG∆Ø·ªúI CH∆†I TRONG SERVER")
print("üìç B√°n k√≠nh " .. MAX_DISTANCE .. " stud | Hi·ªán '0.0 / 0.0' khi ch·∫øt")
print("üîÑ T·ª± ƒë·ªông refresh m·ªói 30s | H·ªó tr·ª£ m·ªçi skin | Kh√¥ng l·ªói")
